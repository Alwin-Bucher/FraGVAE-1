# Fragment Graphical Variational AutoEncoder
## Overview

This repository contains the framework and code for constructing a Fragment Graphical Variational AutoEncoder (FraGVAE) for use with molecular graphs, as described in our [published]() and [preprint]() articles. As directly decoding large graphs is [intractable](https://arxiv.org/abs/1802.03480), here, we demonstrate the first fragment based autoencoder which directly autoencodes a bag of small graphs (subgraphs or fragments) which can be recombined to recreate the larger graph. Encoding is achieved through message passing neural networks ([MPNNs](https://arxiv.org/abs/1704.01212)). This approach appears promising for generating compressed circular fingerprint representations for small datasets as well a generative model for molecular graphs.

To demonstrate the FraGVAE process below we provide the flowchart of the autoencoding of the small molecule Ibruprofen. First FraGVAE encodes the fragment bag and connectivity of the fragments using MPNNs to generate the latent space [Zf, Zc]. After the bag of fragments are autoencoded, reconstruction initializes by randomly selecting a starting fragment from the fragment bag to nucleate reconstruction of the large molecular graph. The decoding algorithm ranks every proposed graph creating a decision tree-based flow of a molecular graph generation. All valid subgraphs are marked with red arrows, graph ranks are marked with dashed arrows and paths selected are marked with solid red arrows.

<p align="center">
    <img width="" height="" src="https://github.com/OE-FET/FraGVAE/blob/master/imgs_gifs/FraGVAE_flowchart_Ibuprofen.png">
</p>

The specifics of the decoding of the bag and connectivity of fragments are demonstrated below in two GIFs. The fragment decoder decodes a bag of circular [fragments](https://github.com/OE-FET/FraGVAE/blob/master/imgs_gifs/ECFP_example.png) centered on an atom (green), similar to extended connectivity fingerprints ([ECFP](https://pubs.acs.org/doi/pdf/10.1021/ci100050t)), with radius one (standard terminology used in chemistry). These small circular fragments are connected to 'dangling atoms' (cyan) which signify the nearest neighboring node connected via a specific bond. The bag of fragments is decoded by iteratively sampling the fragment decoder to determine the probability of the specific center node and nearest neighbor nodes given Zf, previously selected circular fragments, centered nodes and nearest neighbors. The GIF is generated in F1_model.py. **Note Chrome does not support the starting/stopping of GIFs. To walk through the GIFs please install a chrome add-on such as [GIF Scrubber](https://chrome.google.com/webstore/detail/gif-scrubber/gbdacbnhlfdlllckelpdkgeklfjfgcmp?hl=en) or click on the GIF to go to YouTube**.

[![GIF of recombination of fragments](https://github.com/OE-FET/FraGVAE/blob/master/imgs_gifs/Ibuprofen_F1.gif)](https://www.youtube.com/watch?v=fiykijkK9ls)

Here all possible larger fragments are created through the combination of small circular fragments with radius one. Please note larger circular fragments centered on an atom or bond are defined as fragments which include all bonds/atoms within a fixed radius centered on an atom/bond respectively. Construction of larger fragments initiates by selecting a random fragment to nucleate the construction of the graph. Using a decision tree process, a route through the tree is selected by the decoder ranking all proposed fragments using the connectivity Zc of the current, previous and encoded fragments as inputs. All proposed fragments are generated by adding every valid connection between two dangling bonds on the emerging molecule and adding every possible fragment in the fragment bag to every dangling bond in the emerging graph. This process iteratively removes dangling bonds (currently solving dark blue bond) to generate a larger molecular graph. This process terminates when all dangling bonds are accounted for. The GIF is generated in FHO_model.py. A GIF of the process to reconstruct the original molecular graph is demonstrated below.

[![GIF of recombination of fragments](https://github.com/OE-FET/FraGVAE/blob/master/imgs_gifs/Ibuprofen_FHO.gif)](https://www.youtube.com/watch?v=b-27VvGA6R8)


### Short term updates:
- [ ] New user issues (please suggest additions, package modifications)
- [ ] Add option to include charges on atoms
- [ ] Add option to include label for single/double/triple bonds as in rings when decoding fragments
- [ ] Automatic Bayesian optimization of molecules
- [ ] Apache Spark Hypermeter and training integration
- [ ] More tutorials


### Long term updates:
- [ ] Include Tesnsorflow GPU Options
- [ ] Replacing atoms with clusters
- [ ] Convert to Tensorflow 2.0

## Training Data Generation

As it is impossible to marginalize over every possible graph [reconstruction](https://arxiv.org/abs/1805.09076), here we use generators to train our models by randomly selecting a reconstruction pathway through the graph. As this process is non-trivial, we visualize the process below in two animations for expedited troubleshooting. For specific formal details see the [supplementary information]().


### Fragment Training Data generation

Fragment autoencoding training occurs by minimizing the Kullback–Leibler divergence between the probability of the model selecting a fragment subcomponent and the ground truth. The specific fragment, center node and near neighbor are randomly selected (see below). To create similar animations please use F1_test_utils.py (requires updating). 
[![F1_training data](https://github.com/OE-FET/FraGVAE/blob/master/imgs_gifs/F1_test_utils_gif_02.gif)](https://www.youtube.com/watch?v=ywRup_eu__I)

### Fragment Connectivity Training Data generation

Fragment autoencoding training occurs by minimizing the Kullback–Leibler divergence between the probability of the model selecting an emerging molecular structure and the ground truth if the proposed graph is a sub-graph of the final molecular graph. Appropriate and inappropriate emerging graphs are marked in green and red respectively. The generator randomly attempts to form rings by connecting two random dangling bonds and attaching valid fragments from the fragment bag to dangling bond in the emerging graph. Please use the gif generator functionality in FHO generators.py to generate similar GIFs.

[![F1_training data](https://github.com/OE-FET/FraGVAE/blob/master/imgs_gifs/FHO_generator_gif01.gif)](https://www.youtube.com/watch?v=wFQ_lzSpu6Y)

### Questions, problems, collaborations?
For questions or problems please create an [issue](https://github.com/OE-FET/FraGVAE/issues). Please raise issues if sections of code require further explanation. For any collaboration ideas for fundamental concept modifications and extensions please contact me directly (jwarmitage@gmail.com). Always happy to chat. :D

## How to install
### Requirements
Please check [environment.yml](https://github.com/OE-FET/FraGVAE/blob/master/environment.yml) file. Core packages include:
- numpy
- rdkit
- pandas
- keyboard
- tensorflow == 1.14
- cairosvg == 2
- matplotlib == 3

Please create issue if there is a problem.

### Pip Installiation

pip install git+https://github.com/OE-FET/FragVAE

## Components

### Example files
- **Introduction_to_FraGVAE.ipynb** - A jupyter notebook file demonstrating how to generate, train and test simple functionality of FraGVAE.
- **Run_characterization_example.ipynb** - A jupyter notebook file demonstrating how to run testing seen in publication based on trained models. In our example, we perform encoding/decoding with the [ZINC](https://github.com/OE-FET/FraGVAE/tree/master/models/experiment000001), [ESOL](https://github.com/OE-FET/FraGVAE/tree/master/models/experiment000002) and our [organic additive](https://github.com/OE-FET/FraGVAE/tree/master/models/experiment000004) dataset to generate a latent space to predict specific attributes in the small data regime. For all models the experiment parameter file (**exp.json**) contains all information regarding hyperparameters, training information and datasets.
- **characterization.py** - Support file with functions for characterizing datasets using FraGVAE

### FraGVAE Components
- **fragvae.py** - Main module containing FraGVAE object. Object controls training, saving, loading and testing all FragVAE models.
- **f1.py** -  Models for encoding and decoding ECFP fragments with a radius of 1 centered on atoms.
- **fho_model.py** - Models for encoding and decoding the connectivity of ECFP fragments with a radius of 1 centered on atoms using higher order fragments (ECFP with radius >1).
- **layers.py** - Custom graph Keras layers for F1 and FHO models
- **generators.py** - Tensorflow training data generators for F1 and FHO models
- **load_model_parameters.py** - defualt model hyperparameters initializer
- **display_funs.py** - Plotting and GIF creating functions
- **convert_mol_smile_tensor.py** - Functions for converting between smiles, RDKIT mols and tensor graphs
- **vae_callbacks.py** - Tensorflow training callbacks
- **filter_training_data.py** - functions for filtering training data to insure FraGVAE is stable
- **gen_paper_plots.py** - functions to generate plots for FraGVAE paper
- **utils.py** - Extra common functionality
- **f1_test_utils.py** - Testing functionality for F1 decoder. Compares true probabilities to predicted probabilities (requires updating).

## Authors:
The software is written by [John Armitage](https://github.com/jwarmitage) and [Leszek Spalek](https://github.com/LeszkoS). 

## Funding acknowledgements

This work was supported by the Canadian Centennial Scholarship Fund, Christ's College Cambridge and FlexEnable
